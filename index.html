<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Centrality | Monitor Operacional (Mockup modular)</title>
  <style>
    :root{
      --bg:#f2f4f7;
      --panel:#ffffff;
      --border:#d6dbe3;
      --nav:#3f4a57;
      --nav2:#2f3843;
      --accent:#1b74e4;
      --text:#1f2a37;
      --muted:#6b7280;

      /* chart colors (solo mockup) */
      --c1:#2fb86e; /* verde */
      --c2:#f59e0b; /* naranja */
      --c3:#ef4444; /* rojo */
      --c4:#60a5fa; /* azul */
      --c5:#8b5cf6; /* morado */
      --c6:#10b981; /* teal */
      --c7:#a3a3a3; /* gris */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
    }

    /* Header "Monitor en L√≠nea" */
    .brand-header{
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand-title{
      font-size:22px;
      font-weight:900;
      color:#1f3b63;
    }
    .brand-right{
      display:flex;
      align-items:center;
      gap:10px;
      color:#4b5563;
      font-weight:700;
      font-size:12px;
    }
    .logo{
      width:150px;
      height:34px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(90deg,#4f46e5,#7c3aed);
      color:#fff;
      font-weight:900;
      letter-spacing:.5px;
    }

    /* Top nav like Centrality */
    .topbar{
      background:var(--nav);
      color:#e5e7eb;
      padding:8px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
    }
    .topbar .left{
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:5px 8px;
      border-radius:10px;
      font-size:12px;
      color:#f3f4f6;
    }
    .topbar .spacer{flex:1}
    .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      opacity:.95;
    }

    .subbar{
      background:var(--nav2);
      color:#d1d5db;
      padding:7px 12px;
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      overflow:auto;
      white-space:nowrap;
    }
    .tab{
      padding:5px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .tab.active{
      background:rgba(27,116,228,.18);
      border-color:rgba(27,116,228,.35);
      color:#fff;
      font-weight:900;
    }

    /* Layout */
    .wrap{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:12px;
      padding:12px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Left filter panel */
    .filters{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      height: calc(100vh - 146px);
      position:sticky;
      top:12px;
      overflow:auto;
    }
    .filters h3{
      margin:4px 0 10px;
      font-size:13px;
      color:#111827;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .filters .hint{font-size:12px;color:var(--muted);font-weight:800}
    .fgroup{margin:10px 0 12px}
    label{
      display:block;
      font-size:12px;
      color:#374151;
      margin:0 0 6px;
      font-weight:900;
    }
    select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-weight:700;
      color:#111827;
      font-size:13px;
    }
    .btns{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    button{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    button.primary{
      background:var(--accent);
      color:#fff;
      border-color:rgba(27,116,228,.35);
    }

    /* KPI picker */
    .picker{
      margin-top:12px;
      border-top:1px solid var(--border);
      padding-top:12px;
    }
    .picker .search{
      display:flex;
      gap:8px;
      align-items:center;
      margin:8px 0 10px;
    }
    .picker input[type="text"]{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      outline:none;
      font-weight:700;
      font-size:13px;
    }
    .toggle-list{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .toggle-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:12px;
      font-weight:900;
      color:#111827;
    }
    .toggle-item small{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:800;
      margin-top:2px;
    }
    .toggle-item .meta{
      margin-left:auto;
      font-size:11px;
      color:#64748b;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      white-space:nowrap;
    }
    .switch{
      width:44px; height:24px;
      border-radius:999px;
      background:#e5e7eb;
      border:1px solid #d1d5db;
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
    }
    .switch::after{
      content:"";
      width:18px; height:18px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      position:absolute;
      top:2px; left:2px;
      transition:all .15s ease;
    }
    .switch.on{
      background:rgba(47,184,110,.25);
      border-color:rgba(47,184,110,.45);
    }
    .switch.on::after{ left:22px; }

    .quick-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .quick-actions button{
      font-size:12px;
      padding:8px 10px;
    }

    /* Main content */
    .main{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }

    .section{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0 0 10px;
      gap:12px;
    }
    .section-title h2{
      margin:0;
      font-size:13px;
      font-weight:1000;
      color:#243b53;
      letter-spacing:.2px;
    }
    .section-title .meta{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }

    /* Cards grid */
    .grid{
      display:grid;
      gap:10px;
      min-width:0;
    }
    .grid.auto{
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .card{
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      padding:10px;
      min-height:120px;
      min-width:0;
    }
    .card h4{
      margin:0 0 8px;
      font-size:13px;
      font-weight:1000;
      color:#1f3b63;
    }
    .big{
      font-size:34px;
      font-weight:1100;
      letter-spacing:.2px;
      color:#12355b;
      line-height:1;
      margin:6px 0 4px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      line-height:1.25;
    }

    /* charts */
    .chart-wrap{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      min-width:0;
    }
    .legend{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      font-weight:900;
      color:#374151;
      min-width:140px;
    }
    .lg{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:#999;
      border:1px solid rgba(0,0,0,.08);
      flex:0 0 auto;
    }
    .lg b{ margin-left:auto; color:#111827; }

    /* Bars */
    .bars{
      height:92px;
      display:flex;
      align-items:flex-end;
      gap:10px;
      padding:6px 6px 0;
      border-radius:10px;
      background:linear-gradient(180deg,#fafbff,#fff);
      border:1px dashed rgba(17,24,39,.10);
      overflow:hidden;
    }
    .bar{
      width:100%;
      border-radius:8px 8px 4px 4px;
      position:relative;
      min-width:46px;
    }
    .bar span{
      position:absolute;
      top:-20px;
      left:50%;
      transform:translateX(-50%);
      font-size:12px;
      font-weight:1000;
      color:#111827;
      white-space:nowrap;
    }
    .barlabel{
      text-align:center;
      font-size:11px;
      color:#374151;
      font-weight:1000;
      margin-top:6px;
      line-height:1.1;
      max-width:80px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .barcol{
      display:flex;
      flex-direction:column;
      align-items:center;
      width:100%;
      min-width:0;
    }

    /* mini progress */
    .progress{
      height:12px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid var(--border);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--c1),var(--c2),var(--c3));
    }

    /* Responsive */
    @media (max-width: 1200px){
      .wrap{grid-template-columns: 1fr;}
      .filters{position:relative;height:auto}
    }
  </style>
</head>
<body>

  <div class="brand-header">
    <div class="brand-title">Monitor en L√≠nea</div>
    <div class="brand-right">
      <div>Centrality (Mockup modular)</div>
      <div class="logo">grupo saesa</div>
    </div>
  </div>

  <div class="topbar">
    <div class="left">üõ∞Ô∏è Despacho autom√°tico <span class="pill">Consola de supervisi√≥n</span></div>
    <div class="spacer"></div>
    <div class="right">
      <span class="pill">√öltima actualizaci√≥n: <b id="lastUpdate">--:--:--</b></span>
      <span class="pill">Unidad Organizativa</span>
    </div>
  </div>

  <div class="subbar">
    <span class="tab">Pendientes de supervisi√≥n</span>
    <span class="tab">En despacho autom√°tico</span>
    <span class="tab">Solicitudes cambio disponibilidad</span>
    <span class="tab">Configuraci√≥n</span>
    <span class="tab active">Monitor operacional</span>
  </div>

  <div class="wrap">
    <!-- Filters + KPI picker -->
    <aside class="filters">
      <h3>Filtros <span class="hint">Tiempo real</span></h3>

      <div class="fgroup">
        <label>CCD</label>
        <select>
          <option>Todos</option>
          <option>CCD Sur</option>
          <option>CCD Norte</option>
        </select>
      </div>

      <div class="fgroup">
        <label>Zonal</label>
        <select>
          <option>Todas</option>
          <option>Puerto Montt</option>
          <option>Valdivia</option>
          <option>Osorno</option>
          <option>Chilo√©</option>
          <option>Ays√©n</option>
        </select>
      </div>

      <div class="fgroup">
        <label>Comuna</label>
        <select>
          <option>(Multiselecci√≥n)</option>
          <option>Puerto Montt</option>
          <option>Calbuco</option>
          <option>Valdivia</option>
          <option>Osorno</option>
        </select>
      </div>

      <div class="fgroup">
        <label>Brigadas Activas (Tipo de brigada)</label>
        <select>
          <option>Todas</option>
          <option>Operaciones</option>
          <option>Comercial</option>
          <option>Roce</option>
          <option>Mantenimiento</option>
        </select>
      </div>

      <div class="fgroup">
        <label>Brigada</label>
        <select>
          <option>Todas</option>
          <option>BBOO 2017 PTO MONTT</option>
          <option>BBEQ PMM 43</option>
          <option>BBOO ORSOCOM 04</option>
        </select>
      </div>

      <div class="fgroup">
        <label>Ventana</label>
        <select>
          <option>Hoy</option>
          <option>√öltimas 3 horas</option>
          <option>Turno actual</option>
        </select>
      </div>

      <div class="btns">
        <button class="primary" onclick="randomize()">Aplicar</button>
        <button onclick="resetMock()">Reset</button>
      </div>

      <!-- KPI Picker -->
      <div class="picker">
        <h3 style="margin:0">KPIs visibles <span class="hint" id="visibleCount">--</span></h3>

        <div class="search">
          <input id="kpiSearch" type="text" placeholder="Buscar KPI (ej: 'concurrencia', 'vencer', 'improductivo')..." oninput="renderToggles()"/>
        </div>

        <div class="quick-actions">
          <button onclick="showRecommended()">Recomendados</button>
          <button onclick="showAll()">Mostrar todo</button>
          <button onclick="hideAll()">Ocultar todo</button>
        </div>

        <div class="toggle-list" id="toggleList" style="margin-top:10px"></div>

        <div style="margin-top:12px; font-size:12px; color:var(--muted); font-weight:900; line-height:1.35;">
          * Puedes prender/apagar KPIs para pruebas. El layout se reacomoda solo.
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <section class="section">
        <div class="section-title">
          <h2>Monitor operacional (solo hoy)</h2>
          <div class="meta">Tarjetas + barras + ‚Äúquesos‚Äù</div>
        </div>

        <!-- Dynamic KPI grid -->
        <div class="grid auto" id="kpiGrid"></div>
      </section>

    </main>
  </div>

  <script>
    // -------------------------
    // Helpers
    // -------------------------
    function pad(n){ return String(n).padStart(2,'0'); }
    function fmtHMS(seconds){
      seconds = Math.max(0, Math.floor(seconds));
      const h = Math.floor(seconds/3600);
      const m = Math.floor((seconds%3600)/60);
      const s = seconds%60;
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }
    function nowHHMMSS(){
      const d=new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // SVG pie
    function polarToCartesian(cx, cy, r, angleDeg){
      const rad = (angleDeg - 90) * Math.PI / 180.0;
      return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
    }
    function arcPath(cx, cy, r, startAngle, endAngle){
      const start = polarToCartesian(cx, cy, r, endAngle);
      const end = polarToCartesian(cx, cy, r, startAngle);
      const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
      return ["M", cx, cy, "L", start.x, start.y, "A", r, r, 0, largeArcFlag, 0, end.x, end.y, "Z"].join(" ");
    }
    function renderPie(svgEl, values, colors){
      svgEl.innerHTML = "";
      const total = values.reduce((a,b)=>a+b,0) || 1;
      let angle = 0;
      const cx=48, cy=48, r=42; // compacto
      for(let i=0;i<values.length;i++){
        const slice = (values[i]/total)*360;
        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d", arcPath(cx,cy,r, angle, angle+slice));
        path.setAttribute("fill", colors[i]);
        path.setAttribute("stroke", "rgba(0,0,0,.06)");
        path.setAttribute("stroke-width", "1");
        svgEl.appendChild(path);
        angle += slice;
      }
    }

    // Bars
    function renderBars(el, items){
      el.innerHTML = "";
      const max = Math.max(...items.map(x=>x.value), 1);
      items.forEach(it=>{
        const col = document.createElement("div");
        col.className = "barcol";

        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = Math.max(8, (it.value/max)*78) + "px";
        bar.style.background = it.color;

        const val = document.createElement("span");
        val.textContent = it.value;
        bar.appendChild(val);

        const lab = document.createElement("div");
        lab.className = "barlabel";
        lab.title = it.label;
        lab.textContent = it.label;

        col.appendChild(bar);
        col.appendChild(lab);
        el.appendChild(col);
      });
    }

    // -------------------------
    // Mock Data (se actualiza al randomize)
    // -------------------------
    const base = {
      brigadas: { conTarea: 50, sinTarea: 11, pausa: 9 },
      estado: { productivas: 45, asignNoInician: 14, inactivas: 11 },
      prodPct: 64, prodVs: 68,
      comp: 6.7,
      tmeSec: 2*3600 + 35*60 + 17,
      esperaSec: 45*60 + 33,
      improdSec: 3*3600 + 22*60 + 15,
      tareas: { ejecutadas: 265, ejecucion: 203, asignadas: 66, detenidas: 15 },
      criticas: { lt2h: 11, hoy: 25, manana: 104 },
      conc: { dentro: 21, fuera: 9 },

      // extra (para 20+ KPIs)
      fallas: { nuevas: 18, masivas: 3, individuales: 15 },
      backlog: { hoyPend: 320, prox5d: 112, vencidasHoy: 14 },
      despacho: { reasignaciones: 27, reprogramadas: 19, sinInicio: 46 },
      calidad: { autocierre: 7, rechazos: 12, devoluciones: 9 },
      recursos: { enTurno: 62, fueraTurno: 18, extension: 6 },
      tickets: { regulatorio: 204, prioritario: 10, noPrio: 479 },
      km: { recorridos: 380, promedio: 26 },
      comunicaciones: { llamadas: 42, msg: 85 },
      seguridad: { incidentes: 1, casi: 4 }
    };

    let model = JSON.parse(JSON.stringify(base));

    function jitter(n, pct=0.18){
      const delta = n * pct;
      const v = n + (Math.random()*2-1)*delta;
      return Math.max(0, Math.round(v));
    }

    function recomputeDerived(m){
      // % productivas derivado desde estado
      const total = (m.estado.productivas + m.estado.asignNoInician + m.estado.inactivas) || 1;
      m.prodPct = Math.round((m.estado.productivas/total)*100);
      m.prodVs = clamp(m.prodPct + Math.round((Math.random()*2-1)*8), 0, 100);

      // complejidad (mock) basada en cargas
      const brigDisp = Math.max(1, m.brigadas.conTarea + m.brigadas.sinTarea);
      const tareasActivas = m.tareas.ejecucion + m.tareas.asignadas;
      const fallasNuevas = m.fallas.nuevas;
      m.comp = clamp(((tareasActivas + fallasNuevas) / brigDisp) * 2.2, 0.5, 9.5);

      // alertas
      m.alertas = (m.conc.fuera||0) + (m.criticas.lt2h||0) + (m.estado.inactivas||0);

      // ratios extra
      m.ratioCarga = Math.round(((tareasActivas)/(Math.max(1, m.brigadas.conTarea + m.brigadas.pausa))) * 10)/10; // tareas por brigada
      m.tasaDetenidas = Math.round((m.tareas.detenidas / Math.max(1, (m.tareas.ejecucion + m.tareas.asignadas + m.tareas.detenidas))) * 100);
      m.tasaFueraPlazo = Math.round((m.conc.fuera / Math.max(1, (m.conc.fuera + m.conc.dentro))) * 100);

      m.tasaSinInicio = Math.round((m.despacho.sinInicio / Math.max(1, (m.tareas.asignadas + m.despacho.sinInicio))) * 100);
    }

    function randomize(){
      const m = JSON.parse(JSON.stringify(base));

      m.brigadas.conTarea = jitter(base.brigadas.conTarea, .22);
      m.brigadas.sinTarea = jitter(base.brigadas.sinTarea, .40);
      m.brigadas.pausa = jitter(base.brigadas.pausa, .45);

      m.estado.productivas = jitter(base.estado.productivas, .22);
      m.estado.asignNoInician = jitter(base.estado.asignNoInician, .40);
      m.estado.inactivas = jitter(base.estado.inactivas, .50);

      m.tmeSec = jitter(base.tmeSec, .20);
      m.esperaSec = jitter(base.esperaSec, .25);
      m.improdSec = jitter(base.improdSec, .28);

      m.tareas.ejecutadas = jitter(base.tareas.ejecutadas, .22);
      m.tareas.ejecucion = jitter(base.tareas.ejecucion, .22);
      m.tareas.asignadas = jitter(base.tareas.asignadas, .30);
      m.tareas.detenidas = jitter(base.tareas.detenidas, .50);

      m.criticas.lt2h = jitter(base.criticas.lt2h, .60);
      m.criticas.hoy = jitter(base.criticas.hoy, .45);
      m.criticas.manana = jitter(base.criticas.manana, .30);

      m.conc.dentro = jitter(base.conc.dentro, .35);
      m.conc.fuera = jitter(base.conc.fuera, .70);

      m.fallas.nuevas = jitter(base.fallas.nuevas, .55);
      m.fallas.masivas = jitter(base.fallas.masivas, .80);
      m.fallas.individuales = Math.max(0, m.fallas.nuevas - m.fallas.masivas);

      m.backlog.hoyPend = jitter(base.backlog.hoyPend, .25);
      m.backlog.prox5d = jitter(base.backlog.prox5d, .35);
      m.backlog.vencidasHoy = jitter(base.backlog.vencidasHoy, .55);

      m.despacho.reasignaciones = jitter(base.despacho.reasignaciones, .50);
      m.despacho.reprogramadas = jitter(base.despacho.reprogramadas, .45);
      m.despacho.sinInicio = jitter(base.despacho.sinInicio, .35);

      m.calidad.autocierre = jitter(base.calidad.autocierre, .80);
      m.calidad.rechazos = jitter(base.calidad.rechazos, .60);
      m.calidad.devoluciones = jitter(base.calidad.devoluciones, .60);

      m.recursos.enTurno = jitter(base.recursos.enTurno, .25);
      m.recursos.fueraTurno = jitter(base.recursos.fueraTurno, .35);
      m.recursos.extension = jitter(base.recursos.extension, .60);

      m.tickets.regulatorio = jitter(base.tickets.regulatorio, .25);
      m.tickets.prioritario = jitter(base.tickets.prioritario, .90);
      m.tickets.noPrio = jitter(base.tickets.noPrio, .20);

      m.km.recorridos = jitter(base.km.recorridos, .35);
      m.km.promedio = jitter(base.km.promedio, .25);

      m.comunicaciones.llamadas = jitter(base.comunicaciones.llamadas, .60);
      m.comunicaciones.msg = jitter(base.comunicaciones.msg, .45);

      m.seguridad.incidentes = jitter(base.seguridad.incidentes, .90);
      m.seguridad.casi = jitter(base.seguridad.casi, .60);

      recomputeDerived(m);
      model = m;
      renderAll();
    }

    function resetMock(){
      model = JSON.parse(JSON.stringify(base));
      recomputeDerived(model);
      renderAll();
    }

    // -------------------------
    // KPI Registry (>= 20 extra)
    // -------------------------
    // type: "card" | "pie" | "bar"
    const KPIS = [
      // RECOMENDADOS (los ‚Äúcore‚Äù)
      {
        id:"brigadas_activas_pie",
        section:"Recursos",
        title:"Brigadas activas",
        subtitle:"Con tarea / Sin tarea / Pausa-Fuera turno",
        type:"pie",
        recommended:true,
        get: m => ({
          values:[m.brigadas.conTarea, m.brigadas.sinTarea, m.brigadas.pausa],
          labels:["Con tarea","Sin tarea","Pausa/Fuera turno"],
          colors:["var(--c1)","var(--c2)","var(--c4)"]
        })
      },
      {
        id:"estado_brigadas_pie",
        section:"Recursos",
        title:"Estado de brigadas",
        subtitle:"Productivas / Asignadas sin iniciar / Inactivas",
        type:"pie",
        recommended:true,
        get: m => ({
          values:[m.estado.productivas, m.estado.asignNoInician, m.estado.inactivas],
          labels:["Productivas","Asignadas sin iniciar","Inactivas"],
          colors:["var(--c1)","var(--c2)","var(--c3)"]
        })
      },
      {
        id:"prod_pct_card",
        section:"Recursos",
        title:"% Brigadas productivas",
        subtitle:"Meta: 60% ¬∑ vs ayer misma hora",
        type:"card",
        recommended:true,
        get: m => ({ value: m.prodPct + "%", note: `vs ayer: ${m.prodVs}%` })
      },
      {
        id:"complejidad_card",
        section:"Recursos",
        title:"Complejidad operacional",
        subtitle:"(tareas activas + fallas nuevas) / brigadas disponibles",
        type:"card_progress",
        recommended:true,
        get: m => ({ value: m.comp.toFixed(1), pct: clamp((m.comp/8)*100,0,100), note:"Verde <4 ¬∑ Amarillo 4‚Äì6 ¬∑ Rojo >6" })
      },
      {
        id:"tme_card",
        section:"Tiempo",
        title:"TME del d√≠a",
        subtitle:"Meta: 03:00:00",
        type:"card",
        recommended:true,
        get: m => ({ value: fmtHMS(m.tmeSec), note:"Rolling hoy" })
      },
      {
        id:"espera_card",
        section:"Tiempo",
        title:"Tiempo prom. de espera",
        subtitle:"Asignaci√≥n ‚Üí inicio actividad",
        type:"card",
        recommended:true,
        get: m => ({ value: fmtHMS(m.esperaSec), note:"Rolling hoy" })
      },
      {
        id:"improd_card",
        section:"Tiempo",
        title:"Tiempo improductivo del d√≠a",
        subtitle:"Minutos sin actividad (acum. hoy)",
        type:"card",
        recommended:true,
        get: m => ({ value: fmtHMS(m.improdSec), note:"Acumulado turno" })
      },
      {
        id:"tareas_dia_bar",
        section:"Tiempo",
        title:"Tareas del d√≠a",
        subtitle:"Ejecutadas / En ejecuci√≥n / Asignadas / Detenidas",
        type:"bar",
        recommended:true,
        get: m => ({
          items:[
            {label:"Ejecutadas", value:m.tareas.ejecutadas, color:"var(--c1)"},
            {label:"En ejecuci√≥n", value:m.tareas.ejecucion, color:"var(--c4)"},
            {label:"Asignadas", value:m.tareas.asignadas, color:"var(--c2)"},
            {label:"Detenidas", value:m.tareas.detenidas, color:"var(--c3)"}
          ]
        })
      },
      {
        id:"criticas_bar",
        section:"Riesgo",
        title:"Cr√≠ticas pr√≥ximas a vencer",
        subtitle:"< 2h / Hoy / Ma√±ana",
        type:"bar",
        recommended:true,
        get: m => ({
          items:[
            {label:"< 2h", value:m.criticas.lt2h, color:"var(--c3)"},
            {label:"Hoy", value:m.criticas.hoy, color:"var(--c2)"},
            {label:"Ma√±ana", value:m.criticas.manana, color:"var(--c4)"}
          ]
        })
      },
      {
        id:"concurrencia_bar",
        section:"Riesgo",
        title:"Concurrencia ante fallas (hoy)",
        subtitle:"Dentro / Fuera de plazo",
        type:"bar",
        recommended:true,
        get: m => ({
          items:[
            {label:"Dentro", value:m.conc.dentro, color:"var(--c1)"},
            {label:"Fuera", value:m.conc.fuera, color:"var(--c3)"}
          ]
        })
      },
      {
        id:"alertas_card",
        section:"Riesgo",
        title:"Resumen de intervenci√≥n",
        subtitle:"Alertas = Fuera plazo + Cr√≠ticas <2h + Inactivas",
        type:"card",
        recommended:true,
        get: m => ({ value: String(m.alertas), note:"Si sube: reasignar / priorizar / mover recursos" })
      },

      // -------------------------
      // +20 KPIs extra (opciones)
      // -------------------------
      // 1) Recursos detallado
      { id:"brigadas_disponibilidad_pie", section:"Recursos", title:"Disponibilidad de brigadas", subtitle:"En turno / Fuera turno / Extensi√≥n", type:"pie", recommended:false,
        get: m => ({ values:[m.recursos.enTurno, m.recursos.fueraTurno, m.recursos.extension], labels:["En turno","Fuera turno","Extensi√≥n"], colors:["var(--c1)","var(--c7)","var(--c2)"] })
      },
      { id:"ratio_carga_card", section:"Recursos", title:"Carga / capacidad", subtitle:"Tareas activas por brigada (aprox.)", type:"card", recommended:false,
        get: m => ({ value: String(m.ratioCarga), note:"Ayuda a estimar saturaci√≥n" })
      },

      // 2) Falla & incidencias (operaci√≥n viva)
      { id:"fallas_bar", section:"Riesgo", title:"Fallas nuevas (hoy)", subtitle:"Masivas / Individuales", type:"bar", recommended:false,
        get: m => ({ items:[ {label:"Masivas", value:m.fallas.masivas, color:"var(--c3)"},{label:"Individuales", value:m.fallas.individuales, color:"var(--c4)"} ] })
      },
      { id:"tasa_fuera_plazo_card", section:"Riesgo", title:"% Fuera de plazo (hoy)", subtitle:"Fuera / (Dentro + Fuera)", type:"card", recommended:false,
        get: m => ({ value: m.tasaFueraPlazo + "%", note:"Se√±al de riesgo regulatorio" })
      },

      // 3) Backlog (enfocado a HOY / ventana corta)
      { id:"vencidas_hoy_card", section:"Riesgo", title:"Vencidas hoy", subtitle:"Tareas que vencen y siguen abiertas", type:"card", recommended:false,
        get: m => ({ value: String(m.backlog.vencidasHoy), note:"Requiere intervenci√≥n inmediata" })
      },
      { id:"proximas_5d_card", section:"Riesgo", title:"Pr√≥ximas a vencer (5 d√≠as)", subtitle:"Ventana corta (no backlog total)", type:"card", recommended:false,
        get: m => ({ value: String(m.backlog.prox5d), note:"Priorizar antes de que se acumulen" })
      },

      // 4) Despacho/gesti√≥n (acci√≥n del CCD)
      { id:"reasignaciones_card", section:"Tiempo", title:"Reasignaciones (hoy)", subtitle:"Movimientos de despacho durante el turno", type:"card", recommended:false,
        get: m => ({ value: String(m.despacho.reasignaciones), note:"Si sube mucho: posible mala asignaci√≥n inicial" })
      },
      { id:"reprogramadas_card", section:"Tiempo", title:"Reprogramadas (hoy)", subtitle:"Tickets que pasan a reagendar", type:"card", recommended:false,
        get: m => ({ value: String(m.despacho.reprogramadas), note:"Detecta fricci√≥n en terreno / coordinaci√≥n" })
      },
      { id:"sin_inicio_card", section:"Tiempo", title:"Asignadas sin iniciar", subtitle:"Conteo vivo (riesgo de espera)", type:"card", recommended:false,
        get: m => ({ value: String(m.despacho.sinInicio), note:`% aprox: ${m.tasaSinInicio}%` })
      },

      // 5) Calidad de flujo (operaci√≥n real)
      { id:"autocierre_card", section:"Tiempo", title:"Autocierres (hoy)", subtitle:"Casos que se cierran sin gesti√≥n visible", type:"card", recommended:false,
        get: m => ({ value: String(m.calidad.autocierre), note:"√ötil para detectar falsos cierres / gaps" })
      },
      { id:"rechazos_card", section:"Tiempo", title:"Rechazos / devoluciones (hoy)", subtitle:"Problemas de documentaci√≥n / proceso", type:"card", recommended:false,
        get: m => ({ value: String(m.calidad.rechazos), note:`Devoluciones: ${m.calidad.devoluciones}` })
      },

      // 6) Distribuci√≥n de tipos (si te sirve para lectura r√°pida)
      { id:"tickets_tipo_pie", section:"Recursos", title:"Mix de tareas cr√≠ticas (hoy)", subtitle:"Regulatorio / Prioritario / No prioritario", type:"pie", recommended:false,
        get: m => ({ values:[m.tickets.regulatorio, m.tickets.prioritario, m.tickets.noPrio], labels:["Regulatorio","Prioritario","No prioritario"], colors:["var(--c3)","var(--c5)","var(--c4)"] })
      },

      // 7) Detenidas (tensi√≥n operacional)
      { id:"tasa_detenidas_card", section:"Riesgo", title:"% Detenidas", subtitle:"Detenidas / (en ejecuci√≥n + asignadas + detenidas)", type:"card", recommended:false,
        get: m => ({ value: m.tasaDetenidas + "%", note:"Si sube: bloqueos en terreno / coordinaci√≥n" })
      },
      { id:"detenidas_card", section:"Riesgo", title:"Detenidas (conteo)", subtitle:"Tickets detenidos ahora", type:"card", recommended:false,
        get: m => ({ value: String(m.tareas.detenidas), note:"Priorizar desbloqueo" })
      },

      // 8) Actividad del turno (proxy)
      { id:"ejecutadas_card", section:"Tiempo", title:"Ejecutadas (hoy)", subtitle:"Producci√≥n acumulada turno", type:"card", recommended:false,
        get: m => ({ value: String(m.tareas.ejecutadas), note:"Comparar con misma hora (si agregas base)" })
      },
      { id:"en_ejecucion_card", section:"Tiempo", title:"En ejecuci√≥n ahora", subtitle:"Trabajo corriendo", type:"card", recommended:false,
        get: m => ({ value: String(m.tareas.ejecucion), note:"Se√±al de tracci√≥n operativa" })
      },

      // 9) Camino/log√≠stica (si hay datos)
      { id:"km_recorridos_card", section:"Tiempo", title:"Km recorridos (hoy)", subtitle:"Total turnos (si hay GPS/reporte)", type:"card", recommended:false,
        get: m => ({ value: String(m.km.recorridos), note:`Promedio/brigada: ${m.km.promedio} km` })
      },

      // 10) Comunicaci√≥n (si quieres un proxy para saturaci√≥n)
      { id:"llamadas_card", section:"Tiempo", title:"Llamadas / coordinaci√≥n (hoy)", subtitle:"Proxy de fricci√≥n", type:"card", recommended:false,
        get: m => ({ value: String(m.comunicaciones.llamadas), note:`Mensajes: ${m.comunicaciones.msg}` })
      },

      // 11) Seguridad (si aplica)
      { id:"seguridad_card", section:"Riesgo", title:"Seguridad (hoy)", subtitle:"Incidentes / casi-accidentes", type:"bar", recommended:false,
        get: m => ({ items:[ {label:"Incidentes", value:m.seguridad.incidentes, color:"var(--c3)"}, {label:"Casi", value:m.seguridad.casi, color:"var(--c2)"} ] })
      },

      // 12) Concurrencia extendida (distribuci√≥n)
      { id:"concurrencia_pie", section:"Riesgo", title:"Concurrencia (hoy)", subtitle:"Dentro / Fuera", type:"pie", recommended:false,
        get: m => ({ values:[m.conc.dentro, m.conc.fuera], labels:["Dentro","Fuera"], colors:["var(--c1)","var(--c3)"] })
      },

      // 13) Cr√≠ticas como pie (alternativa)
      { id:"criticas_pie", section:"Riesgo", title:"Cr√≠ticas por ventana", subtitle:"< 2h / Hoy / Ma√±ana", type:"pie", recommended:false,
        get: m => ({ values:[m.criticas.lt2h, m.criticas.hoy, m.criticas.manana], labels:["<2h","Hoy","Ma√±ana"], colors:["var(--c3)","var(--c2)","var(--c4)"] })
      },

      // 14) Estado brigadas alternativo (disponibilidad vs actividad)
      { id:"actividad_vs_disponible_bar", section:"Recursos", title:"Actividad vs disponibilidad", subtitle:"Productivas / En turno (proxy)", type:"bar", recommended:false,
        get: m => ({ items:[ {label:"Productivas", value:m.estado.productivas, color:"var(--c1)"},{label:"En turno", value:m.recursos.enTurno, color:"var(--c4)"} ] })
      },

      // 15) Saturaci√≥n de espera (proxy)
      { id:"espera_min_card", section:"Tiempo", title:"Espera (minutos)", subtitle:"Asignaci√≥n ‚Üí inicio (min)", type:"card", recommended:false,
        get: m => ({ value: String(Math.round(m.esperaSec/60)) + " min", note:"M√°s directo para lectura r√°pida" })
      },

      // 16) TME (minutos)
      { id:"tme_min_card", section:"Tiempo", title:"TME (minutos)", subtitle:"Concurrencia media en min", type:"card", recommended:false,
        get: m => ({ value: String(Math.round(m.tmeSec/60)) + " min", note:"Modo r√°pido" })
      },

      // 17) Improductivo (minutos)
      { id:"improd_min_card", section:"Tiempo", title:"Improductivo (min)", subtitle:"Acum. hoy en minutos", type:"card", recommended:false,
        get: m => ({ value: String(Math.round(m.improdSec/60)) + " min", note:"Modo r√°pido" })
      },

      // 18) Capacidad mal usada (sin tarea)
      { id:"sin_tarea_card", section:"Recursos", title:"Brigadas sin tarea", subtitle:"Capacidad ociosa ahora", type:"card", recommended:false,
        get: m => ({ value: String(m.brigadas.sinTarea), note:"Si sube: reasignar tareas cercanas" })
      },

      // 19) Inactivas (estado)
      { id:"inactivas_card", section:"Recursos", title:"Brigadas inactivas", subtitle:"Sin avance visible", type:"card", recommended:false,
        get: m => ({ value: String(m.estado.inactivas), note:"Candidatas a contacto inmediato" })
      },

      // 20) Falla nuevas (conteo)
      { id:"fallas_nuevas_card", section:"Riesgo", title:"Fallas nuevas (conteo)", subtitle:"Ingresos hoy", type:"card", recommended:false,
        get: m => ({ value: String(m.fallas.nuevas), note:`Masivas: ${m.fallas.masivas}` })
      },

      // 21) Pendientes hoy (ventana corta)
      { id:"pendientes_hoy_card", section:"Tiempo", title:"Pendientes hoy (ventana)", subtitle:"Pendientes del d√≠a (no backlog total)", type:"card", recommended:false,
        get: m => ({ value: String(m.backlog.hoyPend), note:"√ötil si lo defines como 'hoy'" })
      },
    ];

    // Visible map
    const visible = Object.fromEntries(KPIS.map(k => [k.id, !!k.recommended]));

    // -------------------------
    // Rendering: KPI cards
    // -------------------------
    function createCard(kpi){
      const data = kpi.get(model);
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.kpi = kpi.id;

      const h = document.createElement("h4");
      h.textContent = kpi.title;
      card.appendChild(h);

      const sub = document.createElement("div");
      sub.className = "sub";
      sub.textContent = kpi.subtitle || "";
      card.appendChild(sub);

      // Spacer
      card.appendChild(document.createElement("div")).style.height = "8px";

      if(kpi.type === "card"){
        const big = document.createElement("div");
        big.className = "big";
        big.textContent = data.value;
        card.appendChild(big);

        const note = document.createElement("div");
        note.className = "sub";
        note.textContent = data.note || "";
        card.appendChild(note);
      }

      if(kpi.type === "card_progress"){
        const big = document.createElement("div");
        big.className = "big";
        big.textContent = data.value;
        card.appendChild(big);

        const note = document.createElement("div");
        note.className = "sub";
        note.textContent = data.note || "";
        card.appendChild(note);

        const pWrap = document.createElement("div");
        pWrap.style.marginTop = "10px";
        const p = document.createElement("div");
        p.className = "progress";
        const fill = document.createElement("div");
        fill.style.width = (data.pct || 0) + "%";
        p.appendChild(fill);
        pWrap.appendChild(p);

        const hint = document.createElement("div");
        hint.className = "sub";
        hint.style.marginTop = "6px";
        hint.textContent = "Nivel actual";
        pWrap.appendChild(hint);

        card.appendChild(pWrap);
      }

      if(kpi.type === "pie"){
        const wrap = document.createElement("div");
        wrap.className = "chart-wrap";

        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("width","96");
        svg.setAttribute("height","96");
        svg.setAttribute("viewBox","0 0 96 96");
        renderPie(svg, data.values, data.colors);

        const legend = document.createElement("div");
        legend.className = "legend";
        data.labels.forEach((lab, i)=>{
          const line = document.createElement("div");
          line.className = "lg";
          const dot = document.createElement("span");
          dot.className = "dot";
          dot.style.background = data.colors[i];
          const t = document.createElement("span");
          t.textContent = lab;
          const b = document.createElement("b");
          b.textContent = data.values[i];
          line.appendChild(dot);
          line.appendChild(t);
          line.appendChild(b);
          legend.appendChild(line);
        });

        wrap.appendChild(svg);
        wrap.appendChild(legend);
        card.appendChild(wrap);
      }

      if(kpi.type === "bar"){
        const bars = document.createElement("div");
        bars.className = "bars";
        renderBars(bars, data.items);
        card.appendChild(bars);
      }

      return card;
    }

    function renderGrid(){
      const grid = document.getElementById("kpiGrid");
      grid.innerHTML = "";

      // orden por secci√≥n para que quede ‚Äúbloqueado‚Äù visualmente
      const sectionOrder = ["Recursos","Tiempo","Riesgo"];
      sectionOrder.forEach(sec=>{
        const group = KPIS.filter(k => k.section===sec && visible[k.id]);
        if(group.length === 0) return;

        // header peque√±o por secci√≥n dentro del grid (tambi√©n es ‚Äúcard‚Äù)
        const header = document.createElement("div");
        header.className = "card";
        header.style.minHeight = "64px";
        header.style.display = "flex";
        header.style.alignItems = "center";
        header.style.justifyContent = "space-between";
        header.style.background = "#fbfcff";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:1100;color:#1f3b63">${sec}</div>
                          <div style="font-size:12px;color:#6b7280;font-weight:900">KPIs visibles: ${group.length}</div>`;
        const right = document.createElement("div");
        right.innerHTML = `<span class="pill" style="background:rgba(27,116,228,.10);border-color:rgba(27,116,228,.20);color:#1f3b63">Secci√≥n</span>`;
        header.appendChild(left);
        header.appendChild(right);
        grid.appendChild(header);

        group.forEach(k => grid.appendChild(createCard(k)));
      });

      document.getElementById("visibleCount").textContent =
        `${Object.values(visible).filter(Boolean).length}/${KPIS.length}`;
    }

    // -------------------------
    // KPI toggles
    // -------------------------
    function renderToggles(){
      const list = document.getElementById("toggleList");
      list.innerHTML = "";
      const q = (document.getElementById("kpiSearch").value || "").toLowerCase().trim();

      KPIS.forEach(k=>{
        const hay = (k.title + " " + (k.subtitle||"") + " " + k.section).toLowerCase();
        if(q && !hay.includes(q)) return;

        const row = document.createElement("div");
        row.className = "toggle-item";

        const sw = document.createElement("div");
        sw.className = "switch" + (visible[k.id] ? " on" : "");
        sw.onclick = () => {
          visible[k.id] = !visible[k.id];
          sw.className = "switch" + (visible[k.id] ? " on" : "");
          renderGrid();
          document.getElementById("visibleCount").textContent =
            `${Object.values(visible).filter(Boolean).length}/${KPIS.length}`;
        };

        const text = document.createElement("div");
        text.style.minWidth = "0";
        text.innerHTML = `<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${k.title}</div>
                          <small>${k.section} ¬∑ ${k.type}</small>`;

        const tag = document.createElement("div");
        tag.className = "meta";
        tag.textContent = k.recommended ? "Recomendado" : "Opcional";

        row.appendChild(sw);
        row.appendChild(text);
        row.appendChild(tag);
        list.appendChild(row);
      });

      document.getElementById("visibleCount").textContent =
        `${Object.values(visible).filter(Boolean).length}/${KPIS.length}`;
    }

    function showRecommended(){
      KPIS.forEach(k => visible[k.id] = !!k.recommended);
      renderToggles();
      renderGrid();
    }
    function showAll(){
      KPIS.forEach(k => visible[k.id] = true);
      renderToggles();
      renderGrid();
    }
    function hideAll(){
      KPIS.forEach(k => visible[k.id] = false);
      renderToggles();
      renderGrid();
    }

    // -------------------------
    // Init
    // -------------------------
    function renderAll(){
      document.getElementById("lastUpdate").textContent = nowHHMMSS();
      renderToggles();
      renderGrid();
    }

    resetMock();
    setInterval(()=>document.getElementById("lastUpdate").textContent = nowHHMMSS(), 1000);
  </script>
</body>
</html>
